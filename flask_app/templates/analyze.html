{% extends "base.html" %}

{% block title %}GCSCAN - 文件分析{% endblock %}

{% block content %}
    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <!-- 消息提示区域 - 带自动消失功能 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="max-w-3xl mx-auto mb-8">
              {% for category, message in messages %}
                <div class="flash-message bg-{{ category }}-50 border-l-4 border-{{ category }} text-{{ category }} p-4 rounded-md shadow-sm transition-all duration-500 ease-in-out transform">
                  <p>{{ message }}</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- 自定义提示框容器 -->
        <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-transform duration-300 scale-95">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div id="alert-icon" class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                            <i class="fa fa-exclamation-triangle text-red-500 text-xl"></i>
                        </div>
                        <h3 id="alert-title" class="text-lg font-semibold text-gray-900">提示</h3>
                    </div>
                    <p id="alert-message" class="text-gray-600 mb-6">提示内容将显示在这里</p>
                    <div class="flex justify-end">
                        <button id="alert-ok" class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90 transition-colors">
                            确定
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面标题 -->
        <div class="text-center mb-12">
            <h1 class="text-3xl font-extrabold text-primary sm:text-4xl">
                GCSCAN 反序列化漏洞利用链检测平台
            </h1>
            <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
                保护您的应用安全，检测潜在风险
            </p>
        </div>
        
        <!-- 文件上传区域 -->
        <div class="max-w-3xl mx-auto bg-white rounded-xl card-shadow p-6 sm:p-8">
            <!-- 表单包裹上传区域 -->
            <form id="upload-form" action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">文件分析</h2>
                    <p class="mt-2 text-gray-600">上传文件以检测反序列化漏洞</p>
                </div>
                
                <!-- 拖放区域 -->
                <div class="border-2 border-dashed border-primary/30 rounded-lg p-10 text-center hover:bg-primary/5 transition-colors duration-300">
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4">
                            <i class="fa fa-file-code-o text-2xl text-primary"></i>
                        </div>
                        <p class="text-gray-600 mb-2">将文件拖到此处或点击上传</p>
                        <p class="text-sm text-gray-500 mb-6">Java程序请上传Jar文件（多个请进行压缩），PHP程序请上传压缩包（zip，tar）</p>

                        <input type="file" id="file-input" name="file" class="hidden" accept="*">
                        
                        <!-- 操作按钮 -->
                        <div class="flex flex-wrap justify-center gap-3">
                            <button type="button" id="select-file-btn" class="bg-primary text-white px-5 py-2 rounded-md text-sm font-medium btn-hover">
                                <i class="fa fa-folder-open mr-1"></i> 选择文件
                            </button>
                            
                            <div class="relative">
                                <select id="language-select" name="language" class="appearance-none bg-gray-100 border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-md leading-tight focus:outline-none focus:bg-white focus:border-primary">
                                    <option value="">选择语言（目标程序）</option>
                                    <option value="Java">Java</option>
                                    <option value="PHP">PHP</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fa fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                            
                            <button type="submit" id="upload-btn" class="bg-accent text-white px-5 py-2 rounded-md text-sm font-medium btn-hover">
                                <i class="fa fa-search mr-1"></i> 上传检测
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- 最近分析结果 -->
        <div class="mt-16">
            <h2 class="text-2xl font-bold text-center text-primary mb-8">最近分析结果</h2>

            <div class="text-right mb-4 max-w-6xl mx-auto px-4">
                <a href="{{ url_for('result') }}" class="inline-flex items-center text-primary hover:text-accent transition-colors">
                    <i class="fa fa-list-alt mr-1"></i> 查看所有分析结果
                    <i class="fa fa-angle-right ml-1 text-xs"></i>
                </a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl card-shadow">
                    <thead>
                        <tr class="bg-primary/10">
                            <th class="py-3 px-6 text-left text-sm font-semibold text-primary">文件名</th>
                            <th class="py-3 px-6 text-left text-sm font-semibold text-primary">文件哈希</th>
                            <th class="py-3 px-6 text-left text-sm font-semibold text-primary">语言</th>
                            <th class="py-3 px-6 text-left text-sm font-semibold text-primary">状态</th>
                            <th class="py-3 px-6 text-left text-sm font-semibold text-primary">操作</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% if limited_records and limited_records|length > 0 %}
                            {% for record in limited_records %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="py-4 px-6 text-sm text-gray-900">{{ record.filename }}</td>
                                <td class="py-4 px-6 text-sm text-gray-900">{{ record.file_hash }}</td>
                                <td class="py-4 px-6 text-sm text-gray-900">{{ record.language }}</td>
                                <td class="py-4 px-6">
                                    {% if record.status == 'finished' %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">已完成</span>
                                    {% elif record.status == 'pending' %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">处理中</span>
                                    {% else %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">失败</span>
                                    {% endif %}
                                </td>
                                <td class="py-4 px-6 text-sm">
                                    <a href="{{ url_for('result', file_hash=record.file_hash) }}" class="text-primary hover:text-accent mr-3">
                                        <i class="fa fa-eye mr-1"></i>查看
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="py-8 px-6 text-center text-sm text-gray-500">
                                    暂无分析记录
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
<script>
    // 自定义提示框功能
    const customAlert = {
        element: document.getElementById('custom-alert'),
        messageElement: document.getElementById('alert-message'),
        titleElement: document.getElementById('alert-title'),
        iconElement: document.getElementById('alert-icon'),
        okButton: document.getElementById('alert-ok'),
        
        // 显示提示框
        show: function(message, type = 'error') {
            // 设置消息内容
            this.messageElement.textContent = message;
            
            // 根据类型设置样式
            if (type === 'error') {
                this.titleElement.textContent = '错误';
                this.iconElement.className = 'w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3';
                this.iconElement.innerHTML = '<i class="fa fa-exclamation-triangle text-red-500 text-xl"></i>';
            } else if (type === 'warning') {
                this.titleElement.textContent = '警告';
                this.iconElement.className = 'w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center mr-3';
                this.iconElement.innerHTML = '<i class="fa fa-exclamation-circle text-yellow-500 text-xl"></i>';
            } else if (type === 'success') {
                this.titleElement.textContent = '成功';
                this.iconElement.className = 'w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3';
                this.iconElement.innerHTML = '<i class="fa fa-check text-green-500 text-xl"></i>';
            }
            
            // 显示并添加动画
            this.element.classList.remove('hidden');
            // 触发重排后添加动画类
            setTimeout(() => {
                this.element.classList.remove('opacity-0');
                this.element.querySelector('div').classList.remove('scale-95');
                this.element.querySelector('div').classList.add('scale-100');
            }, 10);
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
        },
        
        // 隐藏提示框
        hide: function() {
            this.element.classList.add('opacity-0');
            this.element.querySelector('div').classList.remove('scale-100');
            this.element.querySelector('div').classList.add('scale-95');
            
            setTimeout(() => {
                this.element.classList.add('hidden');
                // 恢复背景滚动
                document.body.style.overflow = '';
            }, 300);
        }
    };
    
    // 绑定确定按钮事件
    customAlert.okButton.addEventListener('click', () => {
        customAlert.hide();
    });
    
    // 点击背景关闭提示框
    customAlert.element.addEventListener('click', (e) => {
        if (e.target === customAlert.element) {
            customAlert.hide();
        }
    });
    
    // 按ESC键关闭提示框
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !customAlert.element.classList.contains('hidden')) {
            customAlert.hide();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // 自动隐藏flash消息
        const flashMessages = document.querySelectorAll('.flash-message');
        
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    message.remove();
                }, 500);
            }, 3000);
        });

        // 拖放和文件选择逻辑
        const dropArea = document.querySelector('.border-dashed');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const uploadForm = document.getElementById('upload-form');
        const languageSelect = document.getElementById('language-select');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('bg-primary/10');
            dropArea.classList.add('border-primary');
        }
        
        function unhighlight() {
            dropArea.classList.remove('bg-primary/10');
            dropArea.classList.remove('border-primary');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                fileInput.files = files;
                // 使用自定义提示框替代alert
                customAlert.show(`已选择文件: ${files[0].name}`, 'success');
            }
        }

        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                // 使用自定义提示框替代alert
                customAlert.show(`已选择文件: ${e.target.files[0].name}`, 'success');
            }
        });

        uploadForm.addEventListener('submit', (e) => {
            // 验证语言选择
            if (!languageSelect.value) {
                e.preventDefault();
                customAlert.show('请选择语言类型', 'warning');
                return;
            }

            // 验证文件选择
            if (!fileInput.files || fileInput.files.length === 0) {
                e.preventDefault();
                customAlert.show('请先选择要上传的文件', 'error');
                return;
            }
        });
    });
</script>
{% endblock %}
