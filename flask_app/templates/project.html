{% extends "base.html" %}
{% block title %}项目分析 - {{ meta.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/project.css') }}">
<style>
  /* AI 对话弹窗（浅色主题，和全站一致） */
  .ai-overlay{ position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:2000; }
  .ai-overlay.show{ display:flex; }
  .ai-modal{ width:min(960px, 90vw); height:60vh; background:#fff; color:#0f172a; border-radius:12px; border:1px solid #e2e8f0; box-shadow:0 20px 60px rgba(2,6,23,.2); display:flex; flex-direction:column; overflow:hidden; }
  .ai-head{ padding:.75rem 1rem; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between; }
  .ai-title{ font-weight:700; color:#0F766E; }
  .ai-close{ color:#64748b; cursor:pointer; }
  .ai-msgs{ flex:1; overflow:auto; padding:1rem; background:#fafafa; }
  .ai-msg{ display:flex; gap:.5rem; margin-bottom:.75rem; }
  .ai-msg.user{ flex-direction:row-reverse; }
  .ai-bubble{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:.5rem .75rem; max-width:75%; font-size:.875rem; white-space:pre-wrap; color:#0f172a; }
  .ai-msg.user .ai-bubble{ background:#0ea5e9; color:#fff; border-color:transparent; }
  .thinking{ opacity:.8; }
  .dots::after{ content:''; display:inline-block; width:1.25em; text-align:left; animation:dots steps(4,end) 1.2s infinite; }
  @keyframes dots{ 0%{ content:''} 25%{ content:'.'} 50%{ content:'..'} 75%{ content:'...'} 100%{ content:''} }
  .ai-input{ display:flex; gap:.5rem; padding:.75rem; border-top:1px solid #e2e8f0; }
  .ai-input textarea{ flex:1; resize:none; min-height:40px; max-height:120px; padding:.5rem; border:1px solid #d1d5db; border-radius:8px; background:#fff; color:#0f172a; }
  .ai-input button{ background:#14b8a6; color:#fff; padding:.5rem .9rem; border-radius:.5rem; }
</style>
{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  <div class="page-header flex items-center justify-between">
    <div>
      <h1 class="title text-primary">项目分析</h1>
      <p class="meta mt-1">项目：<code>{{ meta.name }}</code> · 语言：<code>{{ meta.language }}</code> · 哈希：<code>{{ meta.file_hash }}</code></p>
    </div>
    <a class="btn btn-ghost" href="{{ url_for('analyze') }}"><i class="fa fa-arrow-left"></i> 返回分析</a>
  </div>

    <section class="metrics">
      <div class="metric-card">
        <div class="label">链路总数</div>
        <div class="value">{{ chains|length }}</div>
        <div class="desc">已解析的 Gadget 链</div>
      </div>
      <div class="metric-card">
        <div class="label">语言</div>
        <div class="value">{{ meta.language }}</div>
        <div class="desc">当前分析语言</div>
      </div>
      <div class="metric-card">
        <div class="label">项目</div>
        <div class="value">{{ meta.name }}</div>
        <div class="desc">唯一哈希：{{ meta.file_hash[:8] }}…</div>
      </div>
  </section>

  <section class="chain-list">
    {% if chains and chains|length > 0 %}
      {% for c in chains %}
      <article class="chain-card">
        <header class="chain-head">
          <div class="chain-title">第 {{ c.index + 1 }} 条链</div>
          <span class="pill"><i class="fa fa-link"></i> 长度 {{ c.length }}</span>
        </header>
        <div class="kv">
          <div class="k">Source：</div>
          <div class="v">{{ c.entry }}</div>
          <div class="k">Sink：</div>
          <div class="v">{{ c.sink }}</div>
        </div>
        <div class="hr"></div>
        <div class="card-actions">
          <a class="btn btn-secondary" href="{{ url_for('audit', hash=meta.file_hash, idx=c.index, lang=meta.language) }}"><i class="fa fa-search"></i> 在线审计</a>
          <button class="btn btn-primary" data-ai-idx="{{ c.index }}"><i class="fa fa-robot"></i> AI 审计</button>
        </div>
      </article>
      {% endfor %}
    {% else %}
      <div class="chain-card" style="text-align:center; color:#9fb3c8;">暂无链路数据</div>
    {% endif %}
    </section>

  <!-- AI 对话弹窗（居中半屏） -->
  <div id="ai-overlay" class="ai-overlay">
    <div class="ai-modal">
      <div class="ai-head">
        <div class="ai-title"><i class="fa fa-robot mr-1"></i>AI 审计</div>
        <span id="ai-close" class="ai-close"><i class="fa fa-close"></i></span>
      </div>
      <div id="ai-msgs" class="ai-msgs"></div>
      <div class="ai-input">
        <textarea id="ai-input" placeholder="向 AI 提问，Shift+Enter 换行"></textarea>
        <button id="ai-send"><i class="fa fa-paper-plane"></i> 发送</button>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  const BACKEND_AI_ENDPOINT = "/api/ai/audit";
  let currentIdx = 0;
  const overlay = document.getElementById('ai-overlay');
  const msgs = document.getElementById('ai-msgs');
  const ta = document.getElementById('ai-input');
  const sendBtn = document.getElementById('ai-send');
  document.getElementById('ai-close').addEventListener('click', ()=> overlay.classList.remove('show'));
  overlay.addEventListener('click', (e)=>{ if(e.target.id==='ai-overlay') overlay.classList.remove('show'); });

  // 确保对话框挂载在 <body>，避免受父级 transform 影响导致“居中在页面而非视口”
  try {
    if (overlay && overlay.parentElement !== document.body) {
      document.body.appendChild(overlay);
    }
  } catch (_) {}

  function append(role, text){
    const div = document.createElement('div');
    div.className = 'ai-msg ' + (role==='user' ? 'user' : 'assistant');
    const bubble = document.createElement('div');
    bubble.className = 'ai-bubble';
    bubble.textContent = text;
    div.appendChild(bubble);
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return bubble;
  }
  function openChat(idx){
    currentIdx = idx;
    msgs.innerHTML='';
    ta.value='';
    overlay.classList.add('show');
    append('assistant', '我是AI审计助手，可以帮助您分析反序列化漏洞。请问有什么问题？');
  }
  async function send(){
    const q = ta.value.trim();
    if(!q){ ta.focus(); return; }
    append('user', q);
    ta.value='';
    sendBtn.disabled = true;
    try{
      const thinking = append('assistant', '思考中');
      thinking.classList.add('thinking','dots');
      const resp = await fetch(BACKEND_AI_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ hash: '{{ meta.file_hash }}', idx: currentIdx, question: q }) });
      const data = await resp.json();
      // 用回答替换“思考中”气泡
      thinking.classList.remove('thinking','dots');
      thinking.textContent = (!resp.ok) ? ((data && (data.error||data.detail)) || '服务异常') : (data.answer || '（AI 暂无输出）');
    }catch(err){ append('assistant', '请求失败：' + err); }
    finally{ sendBtn.disabled = false; }
  }
  sendBtn.addEventListener('click', send);
  ta.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });
  document.querySelectorAll('button[data-ai-idx]').forEach(btn=> btn.addEventListener('click', ()=> openChat(parseInt(btn.dataset.aiIdx,10)||0)) );
</script>
{% endblock %}
