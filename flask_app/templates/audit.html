{% extends "base.html" %}
{% block title %}åœ¨çº¿å®¡è®¡ - {{ meta.project }}{% endblock %}

{% block extra_css %}
<style>
  /* å®¡è®¡é¡µæ ‡é¢˜åŒºåŸŸï¼šå·¦æ ‡é¢˜ + å³ä¾§å…ƒä¿¡æ¯ï¼Œè‡ªåŠ¨æ¢è¡Œ */
  .audit-head { display: grid; grid-template-columns: 1fr auto; gap: .25rem 1rem; align-items: start; }
  @media (max-width: 768px) { .audit-head { grid-template-columns: 1fr; } .audit-meta { justify-self: start; text-align: left; } }
  .audit-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: #0F766E; line-height: 1.25; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; word-break: break-all; }
  .audit-meta { font-size: .875rem; color: #64748b; max-width: 60ch; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; word-break: break-all; justify-self: end; text-align: right; }
  .audit-meta code { color: #0f172a; }
  /* ä»£ç å—ç­‰å®½å­—ä½“ä¸æ»šåŠ¨ä¼˜åŒ– */
  pre code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; display: block; white-space: pre; }
  /* å°å±æ—¶å¢åŠ å¯è¯»æ€§ */
  @media (max-width: 640px) { .audit-meta { max-width: 100%; } }
  /* è¡Œå·åŒºåŸŸæ›´ç´§å‡‘ */
  .code-ln { color: #94a3b8; }
  .code-line { white-space: pre; }
  /* å…ƒä¿¡æ¯å¼ºè°ƒæ ·å¼ */
  .meta-label { color: #0F766E; font-weight: 600; }
  .meta-value { color: #0f172a; }
  .meta-sep { color: #94a3b8; padding: 0 .25rem; }
  
  /* å›ºå®šæŒ‰é’®æ ·å¼ */
  .fixed-btn-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  .floating-btn {
    background: #008080;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
  }

  .floating-btn:hover {
    background: #006666;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 128, 128, 0.4);
  }

  .floating-btn:active {
    transform: translateY(0);
  }

  /* AIå¯¹è¯æ¡†æ ·å¼ - å³ä¸‹è§’å›ºå®šå°å·§ç‰ˆ */
  .ai-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: transparent; /* å®Œå…¨é€æ˜ï¼Œä¸é®æŒ¡é¡µé¢å†…å®¹ */
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none; /* ç©¿é€ç‚¹å‡»åˆ°ä¸‹å±‚é¡µé¢ */
  }

  .ai-dialog-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .ai-dialog-container {
    position: fixed;
    bottom: 80px; /* åœ¨ASK AIæŒ‰é’®ä¸Šæ–¹ */
    right: 20px;
    background: white;
    border-radius: 12px;
    width: 380px;
    height: 500px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: 1px solid #e5e7eb;
    pointer-events: auto; /* å¯¹è¯æ¡†è‡ªèº«å¯äº¤äº’ */
  }

  .ai-dialog-overlay.show .ai-dialog-container {
    transform: translateY(0) scale(1);
  }

  .ai-dialog-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .ai-dialog-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #0F766E;
  }

  .ai-dialog-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: #64748b;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .ai-dialog-close:hover {
    background: #f1f5f9;
    color: #0F766E;
  }

  .ai-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: 320px;
  }

  .ai-message {
    display: flex;
    margin-bottom: 0.75rem;
    gap: 0.5rem;
  }

  .ai-message.user {
    flex-direction: row-reverse;
  }

  .ai-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #008080;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .ai-message.user .ai-avatar {
    background: #0F766E;
  }

  .ai-content {
    background: #f8fafc;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    max-width: 80%;
    line-height: 1.4;
    font-size: 0.875rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    overflow: hidden;
  }

  .ai-message.user .ai-content {
    background: #008080;
    color: white;
  }

  .ai-input-container {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
  }

  .ai-input-container textarea {
    flex: 1;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.5rem;
    resize: none;
    font-family: inherit;
    font-size: 0.875rem;
    min-height: 36px;
    max-height: 80px;
  }

  .ai-input-container textarea:focus {
    outline: none;
    border-color: #008080;
    box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.1);
  }

  .ai-send-btn {
    background: #008080;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    align-self: flex-end;
    white-space: nowrap;
  }

  .ai-send-btn:hover:not(:disabled) {
    background: #006666;
  }

  .ai-send-btn:disabled {
    background: #94a3b8;
    cursor: not-allowed;
  }

  .hidden {
    display: none !important;
  }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 768px) {
    .fixed-btn-container {
      bottom: 15px;
      right: 15px;
    }
    
    .floating-btn {
      padding: 10px 20px;
      font-size: 13px;
    }

    .ai-dialog-container {
      width: calc(100vw - 30px);
      height: 400px;
      max-height: 70vh;
      bottom: 70px;
      right: 15px;
      left: 15px;
      margin: 0;
    }

    .ai-content {
      max-width: 85%;
      font-size: 0.8125rem;
    }

    .ai-dialog-header {
      padding: 0.75rem;
    }

    .ai-messages-container {
      padding: 0.75rem;
      max-height: 260px;
    }

    .ai-input-container {
      padding: 0.75rem;
    }

    .ai-input-container textarea {
      font-size: 0.8125rem;
      min-height: 32px;
    }

    .ai-send-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
  }

  /* è¶…å°å±å¹•é€‚é… */
  @media (max-width: 480px) {
    .ai-dialog-container {
      width: calc(100vw - 20px);
      right: 10px;
      left: 10px;
      bottom: 65px;
    }
    
    .ai-content {
      max-width: 90%;
    }
  }
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-primary">åœ¨çº¿å®¡è®¡</h1>
      <p class="text-gray-700 mt-1">
        <span class="meta-label">é¡¹ç›®ï¼š</span><span class="meta-value">{{ meta.project }}</span>
        <span class="meta-sep">Â·</span>
        <span class="meta-label">è¯­è¨€ï¼š</span><span class="meta-value">{{ meta.language }}</span>
        <span class="meta-sep">Â·</span>
        <span class="meta-label">é“¾ï¼š</span><span class="meta-value">{{ meta.chain_index }}</span>
        <span class="meta-sep">/</span>
        <span class="meta-label">é•¿åº¦ï¼š</span><span class="meta-value">{{ meta.length }}</span>
      </p>
      <p class="text-gray-600 text-sm mt-1">
        <span class="meta-label">Sourceï¼š</span><code class="meta-value">{{ meta.entry }}</code>
        <span class="meta-label"> â†’</span>
      </p>
      <p class="text-gray-600 text-sm mt-1">
        <span class="meta-label">Sinkï¼š</span><code class="meta-value">{{ meta.sink }}</code>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium btn-hover" href="{{ url_for('result') }}"><i class="fa fa-arrow-left mr-1"></i> è¿”å›ç»“æœ</a>
      <a class="bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium btn-hover" href="{{ url_for('project_view') }}?hash={{ request.args.get('hash') | urlencode }}">
        <i class="fa fa-list-alt mr-1"></i> é¡¹ç›®åˆ†æ
      </a>
    </div>
  </div>

  <div class="space-y-8">
    {% for s in steps %}
    <section class="bg-white rounded-lg card-shadow p-4 sm:p-6">
      <div class="mb-3 audit-head">
        <h2 class="audit-title" title="{{ s.label }}">{{ s.index }}. {{ s.label }}</h2>
        <div class="audit-meta">
          {% if s.rel_path %}
          <span>æ–‡ä»¶ï¼š
            <code title="/{{ s.rel_path }}">{{ s.file_name or s.rel_path }}</code>
          </span>
          {% endif %}
          {% if s.line %}
          <span class="ml-3">å®šä½è¡Œï¼š<span class="font-mono">{{ s.line }}</span></span>
          {% endif %}
        </div>
      </div>
      {% if s.found %}
      <pre class="overflow-auto bg-gray-50 border border-gray-200 rounded-md p-4 text-sm leading-6"><code>{% for line in s.code_lines %}<span class="code-line"><span class="code-ln">{{ '%5d' % (loop.index0 + s.start_line) }}</span> | {{ line | replace('\t', '    ') }}</span>{% endfor %}</code></pre>
      {% else %}
      <div class="text-sm text-gray-500">æœªèƒ½å®šä½åˆ°å¯¹åº”å‡½æ•°ä»£ç ï¼Œå·²çœç•¥ã€‚</div>
      {% endif %}
    </section>
    {% endfor %}
  </div>
  
  <!-- å›ºå®šæŒ‰é’®å®¹å™¨ -->
  <div class="fixed-btn-container">
    <button class="floating-btn" onclick="openAIDialog()">
      <i class="fa fa-robot mr-1"></i>ASK AI
    </button>
  </div>

  <!-- AIå¯¹è¯æ¡† -->
  <div id="ai-dialog" class="ai-dialog-overlay hidden">
    <div class="ai-dialog-container">
      <!-- æ ‡é¢˜æ  -->
      <div class="ai-dialog-header">
        <h3>AIå®¡è®¡åŠ©æ‰‹</h3>
        <button class="ai-dialog-close" onclick="closeAIDialog()">Ã—</button>
      </div>
      
      <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒº -->
      <div class="ai-messages-container" id="ai-messages">
        <!-- AIæ¬¢è¿æ¶ˆæ¯ -->
        <div class="ai-message">
          <div class="ai-avatar">ğŸ¤–</div>
          <div class="ai-content">
            æˆ‘æ˜¯AIå®¡è®¡åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨åˆ†æååºåˆ—åŒ–æ¼æ´ã€‚è¯·é—®æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
          </div>
        </div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="ai-input-container">
        <textarea id="ai-input" placeholder="è¯·è¾“å…¥æ‚¨å…³äºååºåˆ—åŒ–æ¼æ´çš„é—®é¢˜..."></textarea>
        <button class="ai-send-btn" onclick="sendAIMessage()">å‘é€</button>
      </div>
    </div>
  </div>
</main>

<script>
// AIå¯¹è¯æ¡†åŠŸèƒ½
let aiDialog = null;
let aiMessages = null;
let aiInput = null;
let aiSendBtn = null;
let currentThinkingMessage = null;
let currentStreamController = null;

// åç«¯ AI API ç½‘å…³ï¼ˆMCPé£æ ¼ï¼šå‰ç«¯åªè´Ÿè´£æ”¶é›†ä¸Šä¸‹æ–‡å¹¶å‘åç«¯å‘é—®ï¼Œåç«¯æ•´åˆä¸Šä¸‹æ–‡ä¸æ¨¡å‹è°ƒç”¨ï¼‰
const BACKEND_AI_ENDPOINT = "/api/ai/audit";

// ã€æ–°å¢ã€‘ç®€æ˜“ Markdown è½¬æ¢å‡½æ•°ï¼šå¤„ç†æ¢è¡Œã€ç²—ä½“å’Œè¡Œå†…ä»£ç 
function simpleMarkdownToHtml(markdownText) {
    if (!markdownText) return '';
    
    let html = markdownText;

    // 1. å¤šè¡Œä»£ç å—ï¼ˆå¤„ç†è¯­è¨€æ ‡è¯†ï¼Œç®€å•å¤„ç†ï¼Œä¿ç•™æ¢è¡Œï¼‰
    // å¯»æ‰¾è¢« ```[lang]...``` åŒ…è£¹çš„å†…å®¹ã€‚
    // æ­£åˆ™è§£é‡Šï¼š
    // ```       : åŒ¹é…å¼€å¤´çš„ ```
    // (\w*)?    : å¯é€‰åœ°åŒ¹é…è¯­è¨€æ ‡è¯† (å¦‚ js, php)ï¼Œå¹¶æ•è·ä¸º $1
    // \n?       : å¯é€‰åœ°åŒ¹é…ç´§éšå…¶åçš„æ¢è¡Œç¬¦
    // ([\s\S]*?) : éè´ªå©ªåœ°æ•è·å®é™…çš„ä»£ç å†…å®¹ (æ•è·ä¸º $2)
    // ```       : åŒ¹é…ç»“å°¾çš„ ```
    html = html.replace(/```(\w*)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        // lang å˜é‡ä¼šåŒ…å« 'php', 'javascript' ç­‰ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        // code å˜é‡ä¼šåŒ…å«å®é™…çš„ä»£ç å†…å®¹
        
        // å¯¹ä»£ç å—å†…éƒ¨çš„æ¢è¡Œç¬¦è¿›è¡Œå¤„ç†ï¼Œä½¿å…¶åœ¨ <pre> ä¸­æ­£ç¡®æ˜¾ç¤º
        // æ³¨æ„ï¼šè¿™é‡Œä»…å°†å†…éƒ¨çš„ <br> æ¢å› \nï¼Œè®© <pre> æ ‡ç­¾å¤„ç†å…¶å†…éƒ¨çš„ç©ºæ ¼å’Œæ¢è¡Œ
        const cleanedCode = code.replace(/<br>/g, '\n').trim();
        
        // ä¸ºäº†ä¸åŸé¡µé¢çš„ä»£ç å—æ ·å¼å…¼å®¹ï¼Œä¸è¿›è¡Œè¡Œå·å¤„ç†ï¼Œåªä½¿ç”¨ <pre><code>
        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ ¹æ® lang å˜é‡æ·»åŠ ç±»åï¼Œä¾‹å¦‚ï¼šclass="... language-${lang}"
        return `<pre class="overflow-auto bg-gray-100 border border-gray-300 rounded-md p-2 my-2 text-xs leading-5"><code>${cleanedCode}</code></pre>`;
    });

    // 2. æ¢è¡Œç¬¦æ›¿æ¢ä¸º <br> (å¤„ç†å®Œå—çº§å…ƒç´ å)
    html = html.replace(/\n/g, '<br>');

    // 3. ç²—ä½“ **text**
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // 4. è¡Œå†…ä»£ç  `code`
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');
    
    // 5. åˆ—è¡¨ï¼ˆç®€å•å¤„ç†ï¼Œè½¬æ¢ä¸ºæ— åºåˆ—è¡¨ï¼‰
    html = html.replace(/<br>\s*(\*|-|\+)\s*(.*?)(?=<br>|$)/g, (match, p1, p2) => {
        // å°è¯•è½¬æ¢ä¸º <ul><li> ç»“æ„ï¼Œä½†éœ€è¦æ›´å¤æ‚çš„é€»è¾‘æ¥å¤„ç†å¤šè¡Œå’ŒåµŒå¥—
        // ç®€å•æ›¿æ¢ä¸º <li> æ ‡ç­¾ä»¥è¿›è¡Œæ ·å¼åŒºåˆ†
        return `<br>â€¢ ${p2}`;
    });

    return html;
}


function initAIDialog() {
    aiDialog = document.getElementById('ai-dialog');
    aiMessages = document.getElementById('ai-messages');
    aiInput = document.getElementById('ai-input');
    aiSendBtn = document.querySelector('.ai-send-btn');
    
    // ç§»é™¤é®ç½©å±‚ç‚¹å‡»å…³é—­åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥é€‰æ‹©é¡µé¢æ–‡å­—
    // åªä¿ç•™å…³é—­æŒ‰é’®çš„å…³é—­åŠŸèƒ½
    
    // è¾“å…¥æ¡†å›è½¦å‘é€æ¶ˆæ¯
    aiInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAIMessage();
        }
    });
    
    // è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
    aiInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // ESCé”®å…³é—­å¯¹è¯æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && aiDialog.classList.contains('show')) {
            closeAIDialog();
        }
    });
}

function openAIDialog() {
    if (!aiDialog) initAIDialog();
    
    aiDialog.classList.remove('hidden');
    // ä½¿ç”¨setTimeoutç¡®ä¿CSSè¿‡æ¸¡ç”Ÿæ•ˆ
    setTimeout(() => {
        aiDialog.classList.add('show');
        aiInput.focus();
        scrollToLatestMessage();
    }, 10);
}

function closeAIDialog() {
    if (!aiDialog) return;
    
    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚
    if (currentStreamController) {
        currentStreamController.abort();
        currentStreamController = null;
    }
    
    // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯
    if (currentThinkingMessage) {
        currentThinkingMessage.remove();
        currentThinkingMessage = null;
    }
    
    aiDialog.classList.remove('show');
    setTimeout(() => {
        aiDialog.classList.add('hidden');
        setAISendingState(false);
    }, 300);
}

function sendAIMessage() {
    const message = aiInput.value.trim();
    if (!message) return;
    
    // ç¦ç”¨å‘é€æŒ‰é’®å’Œè¾“å…¥æ¡†
    setAISendingState(true);
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage(message, 'user');
    aiInput.value = '';
    aiInput.style.height = 'auto';
    
    // æ˜¾ç¤ºAIæ€è€ƒä¸­çŠ¶æ€
    currentThinkingMessage = addMessage('æ€è€ƒä¸­...', 'ai');
    
  // è°ƒç”¨åç«¯ AI æ¥å£
  callBackendAI(message).catch(error => {
        console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
        // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯
        if (currentThinkingMessage) {
            currentThinkingMessage.remove();
            currentThinkingMessage = null;
        }
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        addMessage('æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚è¯·ç¨åé‡è¯•ã€‚', 'ai');
        setAISendingState(false);
    });
}

// è®¾ç½®AIå‘é€çŠ¶æ€
function setAISendingState(isSending) {
    if (aiSendBtn) {
        aiSendBtn.disabled = isSending;
        aiSendBtn.textContent = isSending ? 'å‘é€ä¸­...' : 'å‘é€';
    }
    if (aiInput) {
        aiInput.disabled = isSending;
    }
}

// è°ƒç”¨åç«¯ AI æ¥å£
async function callBackendAI(userMessage) {
  // è¯»å– URL ä¸­çš„ hash å’Œ idx ä»¥ä¾¿åç«¯ç²¾ç¡®å–æ•°
  const url = new URL(window.location.href);
  const hash = url.searchParams.get('hash');
  const idx = parseInt(url.searchParams.get('idx') || '0', 10);

  currentStreamController = new AbortController();
  const resp = await fetch(BACKEND_AI_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ hash, idx, question: userMessage }),
    signal: currentStreamController.signal
  });
  let data;
  try {
    data = await resp.json();
  } catch (e) {
    data = null;
  }
  if (!resp.ok) {
    const detail = data && (data.detail || data.error || JSON.stringify(data));
    throw new Error('åç«¯AIæ¥å£å¤±è´¥: ' + resp.status + (detail ? (' - ' + detail) : ''));
  }
  if (currentThinkingMessage) {
    currentThinkingMessage.remove();
    currentThinkingMessage = null;
  }
  const answer = data.answer || 'ï¼ˆæ— å›å¤ï¼‰';
  addMessage(answer, 'ai');
  setAISendingState(false);
  currentStreamController = null;
}

// è·å–å®¡è®¡ä¸Šä¸‹æ–‡ä¿¡æ¯
function getAuditContext() {
    const meta = {
        project: document.querySelector('.meta-value:nth-child(1)')?.textContent || 'æœªçŸ¥é¡¹ç›®',
        language: document.querySelector('.meta-value:nth-child(2)')?.textContent || 'æœªçŸ¥è¯­è¨€',
        chainIndex: document.querySelector('.meta-value:nth-child(3)')?.textContent || 'æœªçŸ¥',
        length: document.querySelector('.meta-value:nth-child(4)')?.textContent || 'æœªçŸ¥',
        entry: document.querySelector('.meta-value:nth-child(5)')?.textContent || 'æœªçŸ¥',
        sink: document.querySelector('.meta-value:nth-child(6)')?.textContent || 'æœªçŸ¥'
    };
    
    // è·å–å®¡è®¡æ­¥éª¤ä¿¡æ¯
    const steps = [];
    document.querySelectorAll('section').forEach((section, index) => {
        const title = section.querySelector('.audit-title')?.textContent || '';
        const fileInfo = section.querySelector('code')?.textContent || '';
        const lineInfo = section.querySelector('.font-mono')?.textContent || '';
        steps.push(`æ­¥éª¤${index + 1}: ${title}, æ–‡ä»¶: ${fileInfo}, è¡Œå·: ${lineInfo}`);
    });
    
    return `é¡¹ç›®: ${meta.project}, è¯­è¨€: ${meta.language}, è°ƒç”¨é“¾: ${meta.chainIndex}/${meta.length}, Source: ${meta.entry}, Sink: ${meta.sink}. å®¡è®¡æ­¥éª¤: ${steps.join('; ')}`;
}

// ã€ä¿®æ”¹ç‚¹ã€‘ä¿®æ”¹ addMessageï¼ŒAIæ¶ˆæ¯ä½¿ç”¨ innerHTML å’Œ Markdown è½¬æ¢
function addMessage(content, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${type}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'ai-avatar';
    avatar.textContent = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'ai-content';
    
    if (type === 'ai') {
        // AIæ¶ˆæ¯ï¼šè¿›è¡Œ Markdown è½¬æ¢å’Œæ¢è¡Œå¤„ç†
        contentDiv.innerHTML = simpleMarkdownToHtml(content);
    } else {
        // ç”¨æˆ·æ¶ˆæ¯ï¼šé˜²æ­¢XSSï¼Œä½¿ç”¨ textContent
        contentDiv.textContent = content;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    aiMessages.appendChild(messageDiv);
    
    scrollToLatestMessage();
    return messageDiv;
}

function scrollToLatestMessage() {
    if (aiMessages) {
        aiMessages.scrollTop = aiMessages.scrollHeight;
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // é¢„åˆå§‹åŒ–å¯¹è¯æ¡†ï¼ˆä½†ä¸æ˜¾ç¤ºï¼‰
    initAIDialog();
});
</script>
{% endblock %}
