{% extends "base.html" %}
{% block title %}在线审计 - {{ meta.project }}{% endblock %}

{% block extra_css %}
<style>
  /* 审计页标题区域：左标题 + 右侧元信息，自动换行 */
  .audit-head { display: grid; grid-template-columns: 1fr auto; gap: .25rem 1rem; align-items: start; }
  @media (max-width: 768px) { .audit-head { grid-template-columns: 1fr; } .audit-meta { justify-self: start; text-align: left; } }
  .audit-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: #0F766E; line-height: 1.25; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; word-break: break-all; }
  .audit-meta { font-size: .875rem; color: #64748b; max-width: 60ch; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-clamp: 2; word-break: break-all; justify-self: end; text-align: right; }
  .audit-meta code { color: #0f172a; }
  /* 代码块等宽字体与滚动优化 */
  pre code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; display: block; white-space: pre; }
  /* 小屏时增加可读性 */
  @media (max-width: 640px) { .audit-meta { max-width: 100%; } }
  /* 行号区域更紧凑 */
  .code-ln { color: #94a3b8; }
  .code-line { white-space: pre; }
  /* 元信息强调样式 */
  .meta-label { color: #0F766E; font-weight: 600; }
  .meta-value { color: #0f172a; }
  .meta-sep { color: #94a3b8; padding: 0 .25rem; }
  
  /* 固定按钮样式 */
  .fixed-btn-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  .floating-btn {
    background: #008080;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
  }

  .floating-btn:hover {
    background: #006666;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 128, 128, 0.4);
  }

  .floating-btn:active {
    transform: translateY(0);
  }

  /* AI对话框样式 - 右下角固定小巧版 */
  .ai-dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: transparent; /* 完全透明，不遮挡页面内容 */
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none; /* 穿透点击到下层页面 */
  }

  .ai-dialog-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .ai-dialog-container {
    position: fixed;
    bottom: 80px; /* 在ASK AI按钮上方 */
    right: 20px;
    background: white;
    border-radius: 12px;
    width: 380px;
    height: 500px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border: 1px solid #e5e7eb;
    pointer-events: auto; /* 对话框自身可交互 */
  }

  .ai-dialog-overlay.show .ai-dialog-container {
    transform: translateY(0) scale(1);
  }

  .ai-dialog-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .ai-dialog-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #0F766E;
  }

  .ai-dialog-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: #64748b;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .ai-dialog-close:hover {
    background: #f1f5f9;
    color: #0F766E;
  }

  .ai-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: 320px;
  }

  .ai-message {
    display: flex;
    margin-bottom: 0.75rem;
    gap: 0.5rem;
  }

  .ai-message.user {
    flex-direction: row-reverse;
  }

  .ai-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #008080;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .ai-message.user .ai-avatar {
    background: #0F766E;
  }

  .ai-content {
    background: #f8fafc;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    max-width: 80%;
    line-height: 1.4;
    font-size: 0.875rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    overflow: hidden;
  }

  .ai-message.user .ai-content {
    background: #008080;
    color: white;
  }

  .ai-input-container {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.5rem;
  }

  .ai-input-container textarea {
    flex: 1;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.5rem;
    resize: none;
    font-family: inherit;
    font-size: 0.875rem;
    min-height: 36px;
    max-height: 80px;
  }

  .ai-input-container textarea:focus {
    outline: none;
    border-color: #008080;
    box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.1);
  }

  .ai-send-btn {
    background: #008080;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    align-self: flex-end;
    white-space: nowrap;
  }

  .ai-send-btn:hover:not(:disabled) {
    background: #006666;
  }

  .ai-send-btn:disabled {
    background: #94a3b8;
    cursor: not-allowed;
  }

  .hidden {
    display: none !important;
  }

  /* 移动端适配 */
  @media (max-width: 768px) {
    .fixed-btn-container {
      bottom: 15px;
      right: 15px;
    }
    
    .floating-btn {
      padding: 10px 20px;
      font-size: 13px;
    }

    .ai-dialog-container {
      width: calc(100vw - 30px);
      height: 400px;
      max-height: 70vh;
      bottom: 70px;
      right: 15px;
      left: 15px;
      margin: 0;
    }

    .ai-content {
      max-width: 85%;
      font-size: 0.8125rem;
    }

    .ai-dialog-header {
      padding: 0.75rem;
    }

    .ai-messages-container {
      padding: 0.75rem;
      max-height: 260px;
    }

    .ai-input-container {
      padding: 0.75rem;
    }

    .ai-input-container textarea {
      font-size: 0.8125rem;
      min-height: 32px;
    }

    .ai-send-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.8125rem;
    }
  }

  /* 超小屏幕适配 */
  @media (max-width: 480px) {
    .ai-dialog-container {
      width: calc(100vw - 20px);
      right: 10px;
      left: 10px;
      bottom: 65px;
    }
    
    .ai-content {
      max-width: 90%;
    }
  }
</style>
{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-primary">在线审计</h1>
      <p class="text-gray-700 mt-1">
        <span class="meta-label">项目：</span><span class="meta-value">{{ meta.project }}</span>
        <span class="meta-sep">·</span>
        <span class="meta-label">语言：</span><span class="meta-value">{{ meta.language }}</span>
        <span class="meta-sep">·</span>
        <span class="meta-label">链：</span><span class="meta-value">{{ meta.chain_index }}</span>
        <span class="meta-sep">/</span>
        <span class="meta-label">长度：</span><span class="meta-value">{{ meta.length }}</span>
      </p>
      <p class="text-gray-600 text-sm mt-1">
        <span class="meta-label">Source：</span><code class="meta-value">{{ meta.entry }}</code>
        <span class="meta-label"> →</span>
      </p>
      <p class="text-gray-600 text-sm mt-1">
        <span class="meta-label">Sink：</span><code class="meta-value">{{ meta.sink }}</code>
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a class="bg-primary text-white px-4 py-2 rounded-md text-sm font-medium btn-hover" href="{{ url_for('result') }}"><i class="fa fa-arrow-left mr-1"></i> 返回结果</a>
      <a class="bg-secondary text-white px-4 py-2 rounded-md text-sm font-medium btn-hover" href="{{ url_for('project_view') }}?hash={{ request.args.get('hash') | urlencode }}">
        <i class="fa fa-list-alt mr-1"></i> 项目分析
      </a>
    </div>
  </div>

  <div class="space-y-8">
    {% for s in steps %}
    <section class="bg-white rounded-lg card-shadow p-4 sm:p-6">
      <div class="mb-3 audit-head">
        <h2 class="audit-title" title="{{ s.label }}">{{ s.index }}. {{ s.label }}</h2>
        <div class="audit-meta">
          {% if s.rel_path %}
          <span>文件：
            <code title="/{{ s.rel_path }}">{{ s.file_name or s.rel_path }}</code>
          </span>
          {% endif %}
          {% if s.line %}
          <span class="ml-3">定位行：<span class="font-mono">{{ s.line }}</span></span>
          {% endif %}
        </div>
      </div>
      {% if s.found %}
      <pre class="overflow-auto bg-gray-50 border border-gray-200 rounded-md p-4 text-sm leading-6"><code>{% for line in s.code_lines %}<span class="code-line"><span class="code-ln">{{ '%5d' % (loop.index0 + s.start_line) }}</span> | {{ line | replace('\t', '    ') }}</span>{% endfor %}</code></pre>
      {% else %}
      <div class="text-sm text-gray-500">未能定位到对应函数代码，已省略。</div>
      {% endif %}
    </section>
    {% endfor %}
  </div>
  
  <!-- 固定按钮容器 -->
  <div class="fixed-btn-container">
    <button class="floating-btn" onclick="openAIDialog()">
      <i class="fa fa-robot mr-1"></i>ASK AI
    </button>
  </div>

  <!-- AI对话框 -->
  <div id="ai-dialog" class="ai-dialog-overlay hidden">
    <div class="ai-dialog-container">
      <!-- 标题栏 -->
      <div class="ai-dialog-header">
        <h3>AI审计助手</h3>
        <button class="ai-dialog-close" onclick="closeAIDialog()">×</button>
      </div>
      
      <!-- 消息显示区 -->
      <div class="ai-messages-container" id="ai-messages">
        <!-- AI欢迎消息 -->
        <div class="ai-message">
          <div class="ai-avatar">🤖</div>
          <div class="ai-content">
            我是AI审计助手，可以帮助您分析反序列化漏洞。请问有什么问题？
          </div>
        </div>
      </div>
      
      <!-- 输入区域 -->
      <div class="ai-input-container">
        <textarea id="ai-input" placeholder="请输入您关于反序列化漏洞的问题..."></textarea>
        <button class="ai-send-btn" onclick="sendAIMessage()">发送</button>
      </div>
    </div>
  </div>
</main>

<script>
// AI对话框功能
let aiDialog = null;
let aiMessages = null;
let aiInput = null;
let aiSendBtn = null;
let currentThinkingMessage = null;
let currentStreamController = null;

// 后端 AI API 网关（MCP风格：前端只负责收集上下文并向后端发问，后端整合上下文与模型调用）
const BACKEND_AI_ENDPOINT = "/api/ai/audit";

// 【新增】简易 Markdown 转换函数：处理换行、粗体和行内代码
function simpleMarkdownToHtml(markdownText) {
    if (!markdownText) return '';
    
    let html = markdownText;

    // 1. 多行代码块（处理语言标识，简单处理，保留换行）
    // 寻找被 ```[lang]...``` 包裹的内容。
    // 正则解释：
    // ```       : 匹配开头的 ```
    // (\w*)?    : 可选地匹配语言标识 (如 js, php)，并捕获为 $1
    // \n?       : 可选地匹配紧随其后的换行符
    // ([\s\S]*?) : 非贪婪地捕获实际的代码内容 (捕获为 $2)
    // ```       : 匹配结尾的 ```
    html = html.replace(/```(\w*)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        // lang 变量会包含 'php', 'javascript' 等（如果存在）
        // code 变量会包含实际的代码内容
        
        // 对代码块内部的换行符进行处理，使其在 <pre> 中正确显示
        // 注意：这里仅将内部的 <br> 换回 \n，让 <pre> 标签处理其内部的空格和换行
        const cleanedCode = code.replace(/<br>/g, '\n').trim();
        
        // 为了与原页面的代码块样式兼容，不进行行号处理，只使用 <pre><code>
        // 如果需要，可以根据 lang 变量添加类名，例如：class="... language-${lang}"
        return `<pre class="overflow-auto bg-gray-100 border border-gray-300 rounded-md p-2 my-2 text-xs leading-5"><code>${cleanedCode}</code></pre>`;
    });

    // 2. 换行符替换为 <br> (处理完块级元素后)
    html = html.replace(/\n/g, '<br>');

    // 3. 粗体 **text**
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // 4. 行内代码 `code`
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');
    
    // 5. 列表（简单处理，转换为无序列表）
    html = html.replace(/<br>\s*(\*|-|\+)\s*(.*?)(?=<br>|$)/g, (match, p1, p2) => {
        // 尝试转换为 <ul><li> 结构，但需要更复杂的逻辑来处理多行和嵌套
        // 简单替换为 <li> 标签以进行样式区分
        return `<br>• ${p2}`;
    });

    return html;
}


function initAIDialog() {
    aiDialog = document.getElementById('ai-dialog');
    aiMessages = document.getElementById('ai-messages');
    aiInput = document.getElementById('ai-input');
    aiSendBtn = document.querySelector('.ai-send-btn');
    
    // 移除遮罩层点击关闭功能，让用户可以选择页面文字
    // 只保留关闭按钮的关闭功能
    
    // 输入框回车发送消息
    aiInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAIMessage();
        }
    });
    
    // 输入框自动调整高度
    aiInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // ESC键关闭对话框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && aiDialog.classList.contains('show')) {
            closeAIDialog();
        }
    });
}

function openAIDialog() {
    if (!aiDialog) initAIDialog();
    
    aiDialog.classList.remove('hidden');
    // 使用setTimeout确保CSS过渡生效
    setTimeout(() => {
        aiDialog.classList.add('show');
        aiInput.focus();
        scrollToLatestMessage();
    }, 10);
}

function closeAIDialog() {
    if (!aiDialog) return;
    
    // 取消正在进行的API请求
    if (currentStreamController) {
        currentStreamController.abort();
        currentStreamController = null;
    }
    
    // 移除思考中消息
    if (currentThinkingMessage) {
        currentThinkingMessage.remove();
        currentThinkingMessage = null;
    }
    
    aiDialog.classList.remove('show');
    setTimeout(() => {
        aiDialog.classList.add('hidden');
        setAISendingState(false);
    }, 300);
}

function sendAIMessage() {
    const message = aiInput.value.trim();
    if (!message) return;
    
    // 禁用发送按钮和输入框
    setAISendingState(true);
    
    // 添加用户消息
    addMessage(message, 'user');
    aiInput.value = '';
    aiInput.style.height = 'auto';
    
    // 显示AI思考中状态
    currentThinkingMessage = addMessage('思考中...', 'ai');
    
  // 调用后端 AI 接口
  callBackendAI(message).catch(error => {
        console.error('AI API调用失败:', error);
        // 移除思考中消息
        if (currentThinkingMessage) {
            currentThinkingMessage.remove();
            currentThinkingMessage = null;
        }
        // 显示错误消息
        addMessage('抱歉，AI服务暂时不可用。请稍后重试。', 'ai');
        setAISendingState(false);
    });
}

// 设置AI发送状态
function setAISendingState(isSending) {
    if (aiSendBtn) {
        aiSendBtn.disabled = isSending;
        aiSendBtn.textContent = isSending ? '发送中...' : '发送';
    }
    if (aiInput) {
        aiInput.disabled = isSending;
    }
}

// 调用后端 AI 接口
async function callBackendAI(userMessage) {
  // 读取 URL 中的 hash 和 idx 以便后端精确取数
  const url = new URL(window.location.href);
  const hash = url.searchParams.get('hash');
  const idx = parseInt(url.searchParams.get('idx') || '0', 10);

  currentStreamController = new AbortController();
  const resp = await fetch(BACKEND_AI_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ hash, idx, question: userMessage }),
    signal: currentStreamController.signal
  });
  let data;
  try {
    data = await resp.json();
  } catch (e) {
    data = null;
  }
  if (!resp.ok) {
    const detail = data && (data.detail || data.error || JSON.stringify(data));
    throw new Error('后端AI接口失败: ' + resp.status + (detail ? (' - ' + detail) : ''));
  }
  if (currentThinkingMessage) {
    currentThinkingMessage.remove();
    currentThinkingMessage = null;
  }
  const answer = data.answer || '（无回复）';
  addMessage(answer, 'ai');
  setAISendingState(false);
  currentStreamController = null;
}

// 获取审计上下文信息
function getAuditContext() {
    const meta = {
        project: document.querySelector('.meta-value:nth-child(1)')?.textContent || '未知项目',
        language: document.querySelector('.meta-value:nth-child(2)')?.textContent || '未知语言',
        chainIndex: document.querySelector('.meta-value:nth-child(3)')?.textContent || '未知',
        length: document.querySelector('.meta-value:nth-child(4)')?.textContent || '未知',
        entry: document.querySelector('.meta-value:nth-child(5)')?.textContent || '未知',
        sink: document.querySelector('.meta-value:nth-child(6)')?.textContent || '未知'
    };
    
    // 获取审计步骤信息
    const steps = [];
    document.querySelectorAll('section').forEach((section, index) => {
        const title = section.querySelector('.audit-title')?.textContent || '';
        const fileInfo = section.querySelector('code')?.textContent || '';
        const lineInfo = section.querySelector('.font-mono')?.textContent || '';
        steps.push(`步骤${index + 1}: ${title}, 文件: ${fileInfo}, 行号: ${lineInfo}`);
    });
    
    return `项目: ${meta.project}, 语言: ${meta.language}, 调用链: ${meta.chainIndex}/${meta.length}, Source: ${meta.entry}, Sink: ${meta.sink}. 审计步骤: ${steps.join('; ')}`;
}

// 【修改点】修改 addMessage，AI消息使用 innerHTML 和 Markdown 转换
function addMessage(content, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${type}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'ai-avatar';
    avatar.textContent = type === 'user' ? '👤' : '🤖';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'ai-content';
    
    if (type === 'ai') {
        // AI消息：进行 Markdown 转换和换行处理
        contentDiv.innerHTML = simpleMarkdownToHtml(content);
    } else {
        // 用户消息：防止XSS，使用 textContent
        contentDiv.textContent = content;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    aiMessages.appendChild(messageDiv);
    
    scrollToLatestMessage();
    return messageDiv;
}

function scrollToLatestMessage() {
    if (aiMessages) {
        aiMessages.scrollTop = aiMessages.scrollHeight;
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 预初始化对话框（但不显示）
    initAIDialog();
});
</script>
{% endblock %}
