{% extends "base.html" %}



{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/seamless-slider.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tech-intro.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dynamic-table.css') }}">
{% endblock %}

{% block content %}
    <!-- 系统简介 -->
    <section class="section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6 d-flex justify-content-center ps-lg-4">
                    <img src="{{ url_for('static', filename='images/1.png') }}" alt="反序列化漏洞检测系统" class="img-fluid rounded shadow" style="width: 80%;">
                </div>

                <div class="col-lg-6 d-flex align-items-center">
                    <div class="text-center text-lg-start">
                        <h2 class="section-title fw-bold mb-4">
                            反序列化漏洞检测与防护
                        </h2>
                        <p>
                            抵御反序列化漏洞风险
                        </p>
                        <a href="{{ url_for('analyze') }}" class="btn btn-lg mt-3" style="width: 200px; background-color: var(--primary-blue); color: white;">
                            开始使用
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" style="background-color: #f8f9fa; padding: 60px 0;">
        <div class="container">
            <div class="row justify-content-center mb-10">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">漏洞形成原理</h2>
                </div>
            </div>
            
            <!-- 使用flex布局确保两列等高 -->
            <div class="row" style="display: flex;">
                <!-- 左侧原理说明 - 使用flex填充高度 -->
                <div class="col-lg-4 mb-8 mb-lg-0 d-flex">
                    <div class="bg-white p-6 rounded shadow w-100">
                        <h3 class="fw-bold mb-4" style="color: var(--primary-blue);">什么是序列化与反序列化？</h3>
                        <p class="mb-4">
                            <strong>序列化</strong>是将对象的状态信息转换为可存储或传输形式的过程，通常转换为字节流或文件，以便传输。
                        </p>
                        <p class="mb-4">
                            <strong>反序列化</strong>则是序列化的逆过程，将字节流或字符串恢复为原始对象，其作为编程语言的机制广泛应用于分布式系统、缓存、会话管理等场景。
                        </p>
                        
                        <h3 class="fw-bold mb-4 mt-6" style="color: var(--primary-blue);">漏洞产生的原因</h3>
                        <p class="mb-4">
                            攻击者可以构造恶意的序列化数据，当应用程序对此进行反序列化操作且没有进行安全检查时，攻击者可以通过操作类方法<strong>劫持控制流</strong>，从而抵达危险函数，造成反序列化漏洞攻击。
                        </p>
                    </div>
                </div>
                
                <!-- 右侧原理图示 - 使用flex填充高度并使内容居中 -->
                <div class="col-lg-8 d-flex">
                    <div class="bg-white p-6 rounded shadow w-100 d-flex flex-column justify-content-center">
                        <img src="{{ url_for('static', filename='images/vul.png') }}" alt="反序列化漏洞原理" class="img-fluid rounded mx-auto" style="max-height: 400px;">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" style="background-color: #f8f9fa; padding: 60px 0;">
        <div class="container">
            <div class="row justify-content-center mb-5">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">平台核心意义</h2>
                </div>
            </div>
            
            <div class="row g-5">
                <!-- 漏洞危害 -->
                <div class="col-lg-6">
                    <div class="bg-white p-5 rounded shadow h-100">
                        <div class="d-flex align-items-center mb-4">
                            <div class="feature-icon me-4" style="color: #dc3545;">
                                <i class="fas fa-exclamation-triangle fa-3x"></i>
                            </div>
                            <h3 class="fw-bold mb-0" style="letter-spacing: 0.5px; color: #2d3436; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                反序列化漏洞危害严重
                            </h3>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-exclamation-circle text-danger mt-1 me-3"></i>
                                <div>
                                    <strong>后果严重</strong>
                                    <p class="mb-0 text-muted">攻击者可通过构造特定的恶意序列化数据，实现任意代码执行、文件篡改、权限提升等高危操作，造成严重安全威胁</p>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-exclamation-circle text-danger mt-1 me-3"></i>
                                <div>
                                    <strong>影响广泛</strong>
                                    <p class="mb-0 text-muted">反序列化漏洞长期位列安全风险高发榜单（CWE Top 10 2024），在Java等主流语言应用中占比超过30%，影响众多企业级系统</p>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-exclamation-circle text-danger mt-1 me-3"></i>
                                <div>
                                    <strong>隐蔽性高</strong>
                                    <p class="mb-0 text-muted">攻击链组合多样、触发条件复杂，十分灵活隐蔽，给漏洞检测与防护带来极大挑战</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- 平台意义 -->
                <div class="col-lg-6">
                    <div class="bg-white p-5 rounded shadow h-100">
                        <div class="d-flex align-items-center mb-4">
                            <div class="feature-icon me-4">
                                <img src="{{ url_for('static', filename='images/shield.png') }}" alt="智能检测平台" style="width: 120px; height: 120px;">
                            </div>
                            <h3 class="fw-bold mb-0" style="letter-spacing: 0.5px; color: #2d3436; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                智能检测平台应运而生
                            </h3>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                                <div>
                                    <strong>更精细的静态分析能力</strong>
                                    <p class="mb-0 text-muted">基于深度语义建模的静态分析框架，针对不同语言特性进行了定制化优化。如在PHP中完善了语言特征建模，在Java中构建了更高精度的调用图，从而能在漏洞被利用前识别潜在的利用链，实现事前防御。</p>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                                <div>
                                    <strong>多语言跨适配能力</strong>
                                    <p class="mb-0 text-muted">平台现已支持PHP与Java语言的漏洞检测，并通过模块化架构预留扩展接口，未来可快速适配更多编程语言与框架，满足复杂多样的安全检测需求。</p>
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-start">
                                <i class="fas fa-check-circle text-success mt-1 me-3"></i>
                                <div>
                                    <strong>可视化漏洞链溯源分析</strong>
                                    <p class="mb-0 text-muted">以交互式图形方式直观呈现漏洞传播路径与关键风险节点，并引入AI模型辅助漏洞识别与风险评估，提升分析效率与决策准确性。</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 主要功能 -->
    <section class="section py-10">
        <div class="container">
            <div class="row justify-content-center mb-10">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">核心功能</h2>
                </div>
            </div>
            <div class="row g-8 justify-content-center">
                <!-- 扫描功能 -->
                <div class="col-lg-2 col-md-5 text-center">
                    <div class="feature-icon mb-4 p-4 rounded-circle bg-primary/10" style="width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-search fa-2x text-primary"></i>
                    </div>
                    <h5 class="fw-bold mb-3 mt-3">漏洞链检测</h5>
                    <p class="text-muted">更精确的静态分析助力全面检测反序列化漏洞链</p>
                </div>
                
                <!-- 链接分析 -->
                <div class="col-lg-2 col-md-5 text-center">
                    <div class="feature-icon mb-4 p-4 rounded-circle bg-primary/10" style="width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-link fa-2x text-primary"></i>
                    </div>
                    <h5 class="fw-bold mb-3 mt-3">利用链分析</h5>
                    <p class="text-muted">在线审计+AI辅助深度分析漏洞利用链</p>
                </div>
                
                <!-- 实时监控 -->
                <div class="col-lg-2 col-md-5 text-center">
                    <div class="feature-icon mb-4 p-4 rounded-circle bg-primary/10" style="width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-eye fa-2x text-primary"></i>
                    </div>
                    <h5 class="fw-bold mb-3 mt-3">实时监控</h5>
                    <p class="text-muted">全时段漏洞分析与安全状态监控</p>
                </div>
                
                <!-- 报告生成 -->
                <div class="col-lg-2 col-md-5 text-center">
                    <div class="feature-icon mb-4 p-4 rounded-circle bg-primary/10" style="width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-alt fa-2x text-primary"></i>
                    </div>
                    <h5 class="fw-bold mb-3 mt-3">宏观统计</h5>
                    <p class="text-muted">多维度可视化报表呈现漏洞趋势宏观统计</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 技术简介 -->
    <section class="section" style="padding: 80px 20px; margin: 0 auto; max-width: 1600px;">
        <div class="container-fluid">  <!-- 全宽容器，避免固定宽度限制 -->
            <div class="row justify-content-center mb-10">
                <div class="col-lg-12 text-center">
                    <h2 class="section-title fw-bold">技术概要</h2>
                </div>
                
                <!-- 技术介绍模块 - 使用flex布局实现自适应高度 -->
                <div class="tech-intro-container row mt-10" style="width: 100%; display: flex; align-items: stretch;">
                    <!-- 左侧索引 - 固定宽度，高度自适应内容 -->
                    <div class="tech-nav col-lg-2 col-md-3" style="padding: 40px 20px; background-color: #f8f9fa; border-radius: 8px 0 0 8px;">
                        <ul class="nav-list list-unstyled">
                            <li class="nav-item active" data-target="tech1">基于AST模拟执行的PHP Gadget Chain检测</li>
                            <li class="nav-item" data-target="tech2">基于反序列化引导调用图构建的Java Gadget Chain检测</li>
                        </ul>
                    </div>
                    
                    <!-- 右侧内容 - 自适应剩余宽度，高度随内容自动调整 -->
                    <div class="tech-content col-lg-10 col-md-9" style="padding: 40px; overflow: visible; background-color: white; border-radius: 0 8px 8px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                        <!-- 技术1 -->
                        <div class="content-item active" id="tech1">
                            <div class="content-header">
                                <i class="fas fa-code me-3" style="font-size: 1.5rem;"></i>
                                <h3 class="tech-title">基于AST模拟执行的PHP Gadget Chain检测</h3>
                            </div>
                            <div class="tech-desc" style="margin-top: 30px;">
                                <p>本系统基于<a href="https://github.com/HACHp1/PFortifier" target="_blank">PFortifier</a>工具进行PHP项目的Gadget Chain检测。PFortifier首先会先解析所有类、trait、接口与方法，建立类→方法和方法名→实现类的映射；随后其基于常见的反序列化入口（__unserialize、__destruct、__wakeup）进行模拟执行并标记可控对象做污点传播。为处理分支与动态调用，PFortifier采用局部变量抽象、分支克隆与贪心合并（优先保留含可控对象的分支）等策略，并通过PM_summary按方法名与参数可控性缓存合并结果与检测到的链以加速分析。</p>
                                <img src="assets/images/php-workflow.png" alt="PFortifier" style="max-width: 80%; height: auto; display: block; margin: 30px auto; border: 1px solid #eee; padding: 15px; background-color: #fff;">
                            </div>
                        </div>
                        
                        <!-- 技术2 -->
                        <div class="content-item" id="tech2">
                            <div class="content-header">
                                <i class="fas fa-code me-3" style="font-size: 1.5rem;"></i>
                                <h3 class="tech-title">基于反序列化引导调用图构建的Java Gadget Chain检测</h3>
                            </div>
                            <div class="tech-desc" style="margin-top: 30px;">
                                <p>本系统基于<a href="https://github.com/CGCL-codes/Flash" target="_blank">Flash</a>工具进行Java项目的Gadget Chain检测。Flash首先进行可控性分析，以确定变量是否可以通过反序列化来恢复。然后，它应用一种混合分派方法，根据接收变量的可控性在调用点解析被调用者：如果可控，Flash使用更全面但可能精度较低的技术（例如类层次分析法、代理分派）；否则，则应用更精确的技术（例如指针分析）。Flash还通过处理涉及可控变量的反射来恢复缺失的调用边，并过滤掉不相关的边，以提高准确率和效率</p>
                                <img src="assets/images/java-workflow.png" alt="Flash流程图" style="max-width: 80%; height: auto; display: block; margin: 30px auto; border: 1px solid #eee; padding: 15px; background-color: #fff;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 语言支持 -->
    <section class="section">
        <div class="container">
            <div class="row justify-content-center mb-5">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">已支持语言</h2>
                </div>
            </div>
            <div class="row justify-content-center">
                <!-- Java -->
                <div class="col-lg-3 col-md-4 text-center">
                    <div class="lang-card">
                        <i class="fab fa-java fa-3x mb-3" style="color: #5382A1;"></i>
                        <h4>Java</h4>
                    </div>
                </div>
                
                <!-- PHP -->
                <div class="col-lg-3 col-md-4 text-center">
                    <div class="lang-card">
                        <i class="fab fa-php fa-3x mb-3" style="color: #777BB3;"></i>
                        <h4>PHP</h4>
                    </div>
                </div>
                
                <!-- More -->
                <div class="col-lg-3 col-md-4 text-center">
                    <div class="lang-card">
                        <i class="fas fa-ellipsis-h fa-3x mb-3" style="color: #5F9EA0;"></i>
                        <h4>正在开发</h4>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 工具效果 -->
    <section class="section">
        <div class="container">
            <div class="row justify-content-center mb-5">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">成果展示</h2>
                </div>
            </div>
            <!-- 滑块-->
            <div class="seamless-slider">
                <div class="slider-wrapper">
                    <div class="slider-item active">
                        <div class="row align-items-stretch">
                            <!-- 左侧文字区域（3列） -->
                            <div class="col-lg-3 slider-text">
                                <div class="text-content">
                                    <h3 class="section-title">PHP Gadget Chain检测</h3>
                                    <p class="section-desc">
                                        在31个应用中，PFortifier实现了<strong>92.93%</strong>的漏洞链总覆盖率，并发现了<strong>56</strong>条新链，相比于现有技术表现出明显优势
                                    </p>
                                    <p class="section-desc">
                                        相关论文<a href="https://ieeexplore.ieee.org/document/11023346/" target="_blank" style="color: #007bff; text-decoration: none;">"PFortifier: Mitigating PHP Object Injection Through Automatic Patch Generation"</a>已发表在</em>2025 IEEE Symposium on Security and Privacy (SP)</em>🎉
                                    </p>
                                </div>
                            </div>
                            
                            <!-- 中间PHP工具对比柱状图区域（6列） -->
                            <div class="col-lg-6 php-chart-container">
                                <canvas id="php-tools-chart" style="max-height: 500px;"></canvas>
                            </div>
                            
                            <!-- 右侧新增饼状图区域（3列） -->
                            <div class="col-lg-3 php-pie-chart-container">
                                <canvas id="php-pie-chart" style="max-height: 500px;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 滑块效果展示 -->
                    <div class="slider-item">
                        <div class="row align-items-stretch">
                            <!-- 左侧文字区域（3列） -->
                            <div class="col-lg-3 slider-text">
                                <div class="text-content">
                                    <h3 class="section-title">Java Gadget Chain检测</h3>
                                    <p class="section-desc">
                                        Flash相比于现有的工具有着更低的漏报率（<strong>30.8%</strong>）和误报率（<strong>25.9%</strong>），且在公开数据集中共检测到<strong>90</strong>条未知的漏洞利用链，表现最优
                                    </p>
                                    <p class="section-desc" style="margin-top: 15px;">
                                        相关论文<a href="https://www.usenix.org/conference/usenixsecurity25/presentation/zhang-yiheng" target="_blank" style="color: #007bff; text-decoration: none;">"Precise and Effective Gadget Chain Mining through Deserialization Guided Call Graph Construction"</a>已发表在<em>Proceedings of the 34th USENIX Security Symposium (USENIX Security 2025)</em>🎉</p>
                                </div>
                            </div>
                            
                            <!-- 中间Java工具对比柱状图区域（6列） -->
                            <div class="col-lg-6 java-chart-container">
                                <canvas id="java-tools-chart" style="max-height: 500px;"></canvas>
                            </div>
                            
                            <!-- 右侧新增饼状图区域（3列） -->
                            <div class="col-lg-3 pie-chart-container">
                                <canvas id="java-pie-chart" style="max-height: 500px;"></canvas>
                            </div>
                        </div>
                    </div> 
                </div>
                
                <!-- 导航控制 -->
                <div class="slider-navigation">
                    <button class="nav-btn prev-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="nav-dots">
                        <span class="dot active" data-slide="0"></span>
                        <span class="dot" data-slide="1"></span>
                    </div>
                    <button class="nav-btn next-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 团队介绍 -->
    <section class="section">
        <div class="container">
            <div class="row justify-content-center mb-5">
                <div class="col-lg-8 text-center">
                    <h2 class="section-title fw-bold">未来研究</h2>
                </div>
            </div>
            <div class="row g-4 justify-content-center">
                <!-- 自动化POC生成 -->
                <div class="col-lg-5 col-md-8">
                    <div class="research-card p-5 rounded shadow">
                        <div class="research-icon mb-4">
                            <i class="fas fa-bolt fa-3x" style="color: var(--primary-blue);"></i>
                        </div>
                        <h3 class="fw-bold mb-3">自动化POC生成</h3>
                        <p class="text-muted">
                            研究基于漏洞利用链特征的自动化POC（Proof of Concept）生成技术，通过分析反序列化漏洞链的调用路径和数据依赖关系，自动构造可验证漏洞存在的测试用例。该技术将结合符号执行与模糊测试，实现对复杂漏洞场景的自动验证，提高漏洞验证效率。
                        </p>
                        <p class="mt-3 text-secondary">
                            预期应用：快速验证检测到的漏洞链有效性，支持一键生成可复现的漏洞验证脚本。
                        </p>
                    </div>
                </div>
                
                <!-- 自动化Patch生成 -->
                <div class="col-lg-5 col-md-8">
                    <div class="research-card p-5 rounded shadow">
                        <div class="research-icon mb-4">
                            <i class="fas fa-shield-alt fa-3x" style="color: var(--primary-blue);"></i>
                        </div>
                        <h3 class="fw-bold mb-3">自动化Patch生成</h3>
                        <p class="text-muted">
                            探索基于程序分析的自动化修复技术，针对检测到的反序列化漏洞链，自动生成安全补丁。通过识别漏洞链中的关键调用点和可控输入，采用代码注入、参数校验强化、序列化白名单等策略，在不影响程序正常功能的前提下阻断漏洞利用路径。
                        </p>
                        <p class="mt-3 text-secondary">
                            预期应用：提供漏洞修复建议及自动生成的补丁代码，支持一键应用并验证修复效果。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/seamless-slider.js') }}"></script>
<script src="{{ url_for('static', filename='js/tech-intro.js') }}"></script>
<script src="{{ url_for('static', filename='js/dynamic-table.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
// Java工具对比柱状图数据
const javaToolsData = {
    tools: ['TABBY', 'CRYSTALLIZER', 'JDD', 'FLASH'],
    dimensions: ['FNR（漏报率）', 'FPR（误报率）', 'GC总数'],
    data: {
        'TABBY': { FNR: 0.464, FPR: 0.669, 'GC总数': 55 },
        'CRYSTALLIZER': { FNR: 0.857, FPR: 0.77, 'GC总数': 20 },
        'JDD': { FNR: 0.607, FPR: 0, 'GC总数': 57 },
        'FLASH': { FNR: 0.321, FPR: 0.496, 'GC总数': 128 }
    }
};

// 绿色系配色配置
const chartColors = {
    // 绿色系基础色 - 由深到浅
    darkGreen: 'rgba(0, 100, 0, 0.8)',      // 深绿色
    mediumDarkGreen: 'rgba(34, 139, 34, 0.8)', // 中深绿色
    mediumGreen: 'rgba(60, 179, 113, 0.8)',   // 中绿色
    lightGreen: 'rgba(144, 238, 144, 0.8)',    // 浅绿色
    white: 'rgba(255, 255, 255, 0.8)',
    
    // 边框色 - 对应绿色系
    borderDarkGreen: 'rgba(0, 100, 0, 1)',
    borderMediumGreen: 'rgba(60, 179, 113, 1)',
    borderLightGreen: 'rgba(144, 238, 144, 1)'
};

// 花纹图案定义和图案生成器
const patterns = {
    diagonal: function(ctx, color) {
        const patternCanvas = document.createElement('canvas');
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        const patternCtx = patternCanvas.getContext('2d');
        
        patternCtx.strokeStyle = color || 'rgba(0, 0, 0, 1)';
        patternCtx.lineWidth = 1;
        patternCtx.beginPath();
        patternCtx.moveTo(0, 0);
        patternCtx.lineTo(10, 10);
        patternCtx.stroke();
        
        return ctx.createPattern(patternCanvas, 'repeat');
    },
    dots: function(ctx, color) {
        const patternCanvas = document.createElement('canvas');
        patternCanvas.width = 6;
        patternCanvas.height = 6;
        const patternCtx = patternCanvas.getContext('2d');
        
        patternCtx.fillStyle = color || 'rgba(0, 0, 0, 1)';
        patternCtx.fillRect(0, 0, 2, 2);
        patternCtx.fillRect(4, 4, 2, 2);
        
        return ctx.createPattern(patternCanvas, 'repeat');
    },
    lines: function(ctx, color) {
        const patternCanvas = document.createElement('canvas');
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        const patternCtx = patternCanvas.getContext('2d');
        
        patternCtx.strokeStyle = color || 'rgba(0, 0, 0, 0.4)';
        patternCtx.lineWidth = 1;
        patternCtx.beginPath();
        patternCtx.moveTo(0, 5);
        patternCtx.lineTo(10, 5);
        patternCtx.stroke();
        
        return ctx.createPattern(patternCanvas, 'repeat');
    },
    cross: function(ctx, color) {
        const patternCanvas = document.createElement('canvas');
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        const patternCtx = patternCanvas.getContext('2d');
        
        patternCtx.strokeStyle = color || 'rgba(0, 0, 0, 1)';
        patternCtx.lineWidth = 1;
        patternCtx.beginPath();
        patternCtx.moveTo(0, 0);
        patternCtx.lineTo(10, 10);
        patternCtx.moveTo(10, 0);
        patternCtx.lineTo(0, 10);
        patternCtx.stroke();
        
        return ctx.createPattern(patternCanvas, 'repeat');
    }
};

// 图案填充插件
const patternFillPlugin = {
    id: 'patternFill',
    beforeDraw: function(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
            const meta = chart.getDatasetMeta(datasetIndex);
            if (meta.hidden) return;
            
            meta.data.forEach((element, index) => {
                const patternType = dataset.patternType;
                if (patternType && patterns[patternType]) {
                    const pattern = patterns[patternType](ctx, dataset.patternColor);
                    if (pattern) {
                        element.options.backgroundColor = pattern;
                    }
                }
            });
        });
    }
};

// 注册图案填充插件
Chart.register(patternFillPlugin);

// 初始化Java工具对比柱状图
function initJavaToolsChart() {
    const ctx = document.getElementById('java-tools-chart');
    if (!ctx) return;
    
    // 多维度数据配置
    const multiDimensionData = {
        labels: javaToolsData.tools,
        datasets: [
            {
                label: 'FNR（漏报率）',
                data: javaToolsData.tools.map(tool => javaToolsData.data[tool].FNR),
                backgroundColor: chartColors.darkGreen, // 深绿色
                borderColor: 'rgba(0, 100, 0, 1)',
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y'  // 使用左侧Y轴
            },
            {
                label: 'FPR（误报率）',
                data: javaToolsData.tools.map(tool => javaToolsData.data[tool].FPR),
                backgroundColor: chartColors.mediumDarkGreen, // 中深绿色
                borderColor: 'rgba(34, 139, 34, 1)',
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y'  // 使用左侧Y轴
            },
            {
                label: 'GC总数',
                data: javaToolsData.tools.map(tool => javaToolsData.data[tool]['GC总数']),
                backgroundColor: chartColors.mediumGreen, // 中绿色
                borderColor: chartColors.borderMediumGreen,
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y1'  // 使用右侧Y轴
            }
        ]
    };
    
    // 创建分组柱状图
    const chart = new Chart(ctx, {
        type: 'bar',
        data: multiDimensionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Java工具多维度性能对比',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    padding: 20
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: '#000',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    anchor: 'end',   // 锚在柱子的顶端
                    align: 'top',    // 文字对齐到柱子顶部
                    offset: 2,       // 离柱子顶部的距离（像素）
                    formatter: function(value, context) {
                        const datasetLabel = context.dataset.label;
                        if (datasetLabel && (datasetLabel.includes('FNR') || datasetLabel.includes('FPR'))) {
                            return (value * 100).toFixed(1) + '%';
                        } else {
                            return value;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '检测工具',
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    title: {
                        display: true,
                        text: 'FNR/FPR（比率）',
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    },
                    position: 'left',
                    ticks: {
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return (value * 100).toFixed(0) + '%';
                        }
                    }
                },
                y1: {
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false,
                    },
                    title: {
                        display: true,
                        text: 'GC总数',
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    },
                    position: 'right',
                    ticks: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            animation: false
        }
    });
}

// PHP工具数据定义（数据直接嵌入）
const phpToolsData = {
    tools: ['FUGIO', 'PFORTIFIER'],
    dimensions: ['FNR（漏报率）', 'FPR（误报率）', 'GC总数'],
    data: {
        "FUGIO": { "FNR": 0.5116, "FPR": 0.7756, "GC总数": 30 },
        "PFORTIFIER": { "FNR": 0.1628, "FPR": 0.6869, "GC总数": 92}
    }
};

// 初始化PHP工具对比柱状图
function initPhpToolsChart() {
    const ctx = document.getElementById('php-tools-chart');
    if (!ctx) return;
    
    // 多维度数据配置（使用嵌入数据）
    const multiDimensionData = {
        labels: phpToolsData.tools,
        datasets: [
            {
                label: 'FNR（漏报率）',
                data: phpToolsData.tools.map(tool => phpToolsData.data[tool].FNR),
                backgroundColor: chartColors.darkGreen, // 深绿色
                borderColor: 'rgba(0, 100, 0, 1)',
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y'
            },
            {
                label: 'FPR（误报率）',
                data: phpToolsData.tools.map(tool => phpToolsData.data[tool].FPR),
                backgroundColor: chartColors.mediumDarkGreen, // 中深绿色
                borderColor: 'rgba(34, 139, 34, 1)',
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y'
            },
            {
                label: 'GC总数',
                data: phpToolsData.tools.map(tool => phpToolsData.data[tool]['GC总数']),
                backgroundColor: chartColors.mediumGreen, // 中绿色
                borderColor: chartColors.borderMediumGreen,
                borderWidth: 2,
                borderRadius: 4,
                yAxisID: 'y1'
            }
        ]
    };
    
    // 创建图表
    const chart = new Chart(ctx, {
        type: 'bar',
        data: multiDimensionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'PHP工具多维度性能对比',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: '#000',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    anchor: 'end',   // 锚在柱子的顶端
                    align: 'top',    // 文字对齐到柱子顶部
                    offset: 2,       // 离柱子顶部的距离（像素）
                    formatter: function(value, context) {
                        const datasetLabel = context.dataset.label;
                        if (datasetLabel && (datasetLabel.includes('FNR') || datasetLabel.includes('FPR'))) {
                            return (value * 100).toFixed(1) + '%';
                        } else {
                            return value;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    title: { 
                        display: true, 
                        text: '检测工具',
                        font: { size: 13, weight: 'bold' }
                    },
                    ticks: {
                        font: { size: 12, weight: 'bold' },
                        color: '#333',
                        padding: 10,
                        maxRotation: 0,
                        minRotation: 0,
                        autoSkip: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.1)' },
                    title: { 
                        display: true, 
                        text: 'FNR/FPR（比率）',
                        font: { size: 13, weight: 'bold' }
                    },
                    position: 'left',
                    ticks: {
                        font: { size: 11 },
                        callback: function(value) {
                            return (value * 100).toFixed(0) + '%';
                        }
                    }
                },
                y1: {
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    title: { 
                        display: true, 
                        text: 'GC总数',
                        font: { size: 13, weight: 'bold' }
                    },
                    position: 'right',
                    ticks: { font: { size: 11 } }
                }
            },
            animation: false
        }
    });
}

// Java工具饼状图数据定义
const javaPieData = {
    tools: ['TABBY', 'CRYSTALLIZER', 'JDD', 'FLASH'],
    data: {
        'TABBY': 55,    // GC总数
        'CRYSTALLIZER': 20,
        'JDD': 57,
        'FLASH': 128
    },
    colors: [
        chartColors.darkGreen,           // 深绿色 - TABBY
        chartColors.mediumDarkGreen,     // 中深绿色 - CRYSTALLIZER
        chartColors.mediumGreen,         // 中绿色 - JDD
        chartColors.lightGreen          // 浅绿色 - FLASH
    ]
};

// 初始化Java工具饼状图
function initJavaPieChart() {
    const ctx = document.getElementById('java-pie-chart');
    if (!ctx) return;
    
    const pieData = {
        labels: javaPieData.tools,
        datasets: [{
            data: javaPieData.tools.map(tool => javaPieData.data[tool]),
            backgroundColor: javaPieData.colors,
            borderColor: javaPieData.colors.map(color => color.replace('0.8', '1')),
            borderWidth: 2,
            hoverOffset: 15,
            patternType: ['diagonal', 'dots', 'lines', 'cross'] // 为每个扇区分配不同的花纹
        }]
    };
    
    const chart = new Chart(ctx, {
        type: 'pie',
        data: pieData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'GC总数分布',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: '#000',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            animation: false
        }
    });
}

// PHP工具饼状图数据定义
const phpPieData = {
    tools: ['FUGIO', 'PFORTIFIER'],
    data: {
        'FUGIO': 30,    // GC总数
        'PFORTIFIER': 92
    },
    colors: [
        chartColors.darkGreen,           // 深绿色 - FUGIO
        chartColors.mediumGreen         // 中绿色 - PFORTIFIER
    ]
};

// 初始化PHP工具饼状图
function initPhpPieChart() {
    const ctx = document.getElementById('php-pie-chart');
    if (!ctx) return;
    
    const pieData = {
        labels: phpPieData.tools,
        datasets: [{
            data: phpPieData.tools.map(tool => phpPieData.data[tool]),
            backgroundColor: phpPieData.colors,
            borderColor: phpPieData.colors.map(color => color.replace('0.8', '1')),
            borderWidth: 2,
            hoverOffset: 15,
            patternType: ['diagonal', 'dots'] // 为每个扇区分配不同的花纹
        }]
    };
    
    const chart = new Chart(ctx, {
        type: 'pie',
        data: pieData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'GC总数分布',
                    font: { size: 16, weight: 'bold' },
                    padding: 20
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: { size: 12, weight: 'bold' }
                    }
                },
                tooltip: {
                    enabled: false
                },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value;
                    }
                }
            },
            animation: false
        }
    });
}

// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', function() {
    Chart.register(ChartDataLabels);
    initJavaToolsChart();
    initPhpToolsChart();
    initJavaPieChart();
    initPhpPieChart();
});
</script>
{% endblock %}